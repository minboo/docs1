(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{323:function(t,s,a){"use strict";a.r(s);var n=a(8),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"nginx-至-https"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-至-https"}},[t._v("#")]),t._v(" Nginx 至 HTTPS")]),t._v(" "),s("p",[t._v("HTTPS（HyperText Transfer Protocol Secure）即超文本传输安全协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。")]),t._v(" "),s("h2",{attrs:{id:"增加-ssl-模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#增加-ssl-模块"}},[t._v("#")]),t._v(" 增加 SSL 模块")]),t._v(" "),s("p",[t._v("部分早期编译安装的 nginx 缺乏 ssl 模块，先查看一下当前模块：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("/path/sbin/nginx "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-V")]),t._v("\n")])])]),s("p",[t._v("回到安装包位置，找到 "),s("code",[t._v("configure")]),t._v(" 文件：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("./configure "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--prefix")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/nginx --with-http_ssl_module\n")])])]),s("p",[t._v("取代现有：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 生成 ./objs/nginx")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 备份")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /path/sbin/nginx /path/sbin/nginx.bak\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 覆盖前先停止 nginx 服务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" ./objs/nginx /path/sbin/\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 再验证")]),t._v("\n/path/sbin/nginx "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-V")]),t._v("\n")])])]),s("h2",{attrs:{id:"阿里云证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#阿里云证书"}},[t._v("#")]),t._v(" 阿里云证书")]),t._v(" "),s("h3",{attrs:{id:"_1-申请证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-申请证书"}},[t._v("#")]),t._v(" 1. 申请证书")]),t._v(" "),s("p",[t._v("阿里云也提供了 SSL 证书的功能，购买"),s("a",{attrs:{href:"https://common-buy.aliyun.com/?spm=5176.2020520163.cas.3.646456a7X7VPVZ&commodityCode=cas#/buy",target:"_blank",rel:"noopener noreferrer"}},[t._v("免费型 DV SSL"),s("OutboundLink")],1),t._v("（在小字提示中可以注意到免费证书可以申请 20 个），购买成功后会在 SSL 证书控制台看到一个未签发的证书。")]),t._v(" "),s("p",[t._v("点击申请，然后绑定域名即可，例如 "),s("code",[t._v("blog.shanyuhai.top")]),t._v("，稍等片刻即可等待审核完成。")]),t._v(" "),s("h3",{attrs:{id:"_2-安装证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装证书"}},[t._v("#")]),t._v(" 2. 安装证书")]),t._v(" "),s("p",[t._v("找到域名对应的证书，下载至本地，然后上传至服务器。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建证书目录")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /etc/nginx/certs\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拷贝证书到 certs 目录下")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" ~/downloads/blog.shanyuhai.top_nginx.zip /etc/nginx/certs\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解压")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" blog.shanyuhai.top_nginx.zip\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改命名")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" 2813835_blog.shanyuhai.top.key blog.shanyuhai.top.key\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" 2813835_blog.shanyuhai.top.key blog.shanyuhai.top.key\n")])])]),s("h3",{attrs:{id:"_3-修改-conf-文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改-conf-文件"}},[t._v("#")]),t._v(" 3. 修改 "),s("code",[t._v(".conf")]),t._v(" 文件")]),t._v(" "),s("p",[t._v("找到之前 Nginx 对应的 "),s("code",[t._v("blog.shanyuhai.top")]),t._v(" 的配置文件。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/nginx/conf.d/blog.conf\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加如下内容")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name blog.shanyuhai.top"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 证书文件")]),t._v("\n  ssl_certificate certs/blog.shanyuhai.top.pem"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 秘钥文件")]),t._v("\n  ssl_certificate_key certs/blog.shanyuhai.top.key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  ssl_session_timeout 5m"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("NULL:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("aNULL:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("MD5:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ADH:"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("RC4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ssl_prefer_server_ciphers on"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n  location / "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root /var/www/html/blog"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    index index.html"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 接着访问 https://blog.shanyuhai.top 验证")]),t._v("\n")])])]),s("h3",{attrs:{id:"_4-重定向-http-到-https"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-重定向-http-到-https"}},[t._v("#")]),t._v(" 4. 重定向 http 到 https")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将 80 端口的虚拟机修改为以下内容")]),t._v("\nserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  listen       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  server_name  blog.shanyuhai.top"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  access_log  /var/log/nginx/blog.access.log  main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  rewrite ^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(".*"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" https://"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" permanent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" nginx "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" reload "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启 nginx 服务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 接着访问 http://blog.shanyuhai.top 验证")]),t._v("\n")])])]),s("h2",{attrs:{id:"let-s-encrypt-证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#let-s-encrypt-证书"}},[t._v("#")]),t._v(" Let's Encrypt 证书")]),t._v(" "),s("h3",{attrs:{id:"_1-说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-说明"}},[t._v("#")]),t._v(" 1. 说明")]),t._v(" "),s("p",[t._v("Let's Encrypt 提供的 "),s("a",{attrs:{href:"https://certbot.eff.org/instructions",target:"_blank",rel:"noopener noreferrer"}},[t._v("certbot"),s("OutboundLink")],1),t._v(" 可以快速生成证书，并能够自动完成配置。")]),t._v(" "),s("blockquote",[s("p",[t._v("还原阿里云做的配置，并打开网站验证是否还原。")])]),t._v(" "),s("p",[t._v("选择 Nginx 和 Ubuntu 18.04 后就会弹出对应的"),s("a",{attrs:{href:"https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx",target:"_blank",rel:"noopener noreferrer"}},[t._v("安装步骤"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"_2-add-certbot-ppa"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-add-certbot-ppa"}},[t._v("#")]),t._v(" 2. Add Certbot PPA")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" software-properties-common\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" add-apt-repository universe\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" add-apt-repository ppa:certbot/certbot\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n")])])]),s("h3",{attrs:{id:"_3-install-certbot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-install-certbot"}},[t._v("#")]),t._v(" 3. Install Certbot")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" certbot python-certbot-nginx\n")])])]),s("h3",{attrs:{id:"_4-get-and-install-your-certificates"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-get-and-install-your-certificates"}},[t._v("#")]),t._v(" 4. Get and install your certificates")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行后根据提示一步步安装即可")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" certbot "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--nginx")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/nginx/conf.d/blog.conf "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看变化")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 访问 https://blog.shanyuhai.top 验证")]),t._v("\n")])])]),s("h3",{attrs:{id:"_5-test-automatic-renewal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-test-automatic-renewal"}},[t._v("#")]),t._v(" 5. Test automatic renewal")]),t._v(" "),s("p",[t._v("Let’s Encrypt 证书的有效期为 90 天，所以需要自动续订。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" certbot renew --dry-run\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{353:function(s,a,t){"use strict";t.r(a);var e=t(8),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"ssh-让你的服务器更安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-让你的服务器更安全"}},[s._v("#")]),s._v(" SSH 让你的服务器更安全")]),s._v(" "),a("p",[s._v("安全是相对而言的，正在不断探索中。")]),s._v(" "),a("h2",{attrs:{id:"ssh-架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-架构"}},[s._v("#")]),s._v(" SSH 架构")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Secure_Shell_Protocol",target:"_blank",rel:"noopener noreferrer"}},[a("strong",[s._v("Secure Shell Protocol")]),s._v(" ("),a("strong",[s._v("SSH")]),s._v(")"),a("OutboundLink")],1),s._v(" 分为两个部分，默认安装：")]),s._v(" "),a("ul",[a("li",[s._v("客户端(ssh)：全局配置路径为 "),a("code",[s._v("/etc/ssh/ssh_config")]),s._v("，当前用户为 "),a("code",[s._v("~/.ssh")]),s._v("。")]),s._v(" "),a("li",[s._v("服务端(sshd)：全局配置路径为 "),a("code",[s._v("/etc/ssh/sshd_config")]),s._v("，以及对应用户的 "),a("code",[s._v("~/.ssh/authorized_keys")]),s._v("。")])]),s._v(" "),a("h3",{attrs:{id:"客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端"}},[s._v("#")]),s._v(" 客户端")]),s._v(" "),a("p",[s._v("访问服务器，第一次访问服务器会出现认证提示：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user 为用户名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# hostname 为主机名（域名、IP）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" user@hostname\n")])])]),a("p",[s._v("也可以快速执行服务器命令：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行 ls")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" user@hostname "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-al")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 交互式需添加 -t")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" user@hostname "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" xxx.conf\n")])])]),a("h3",{attrs:{id:"客户端生成-ssh-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端生成-ssh-key"}},[s._v("#")]),s._v(" 客户端生成 SSH Key")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 利用邮箱生成 ssh key")]),s._v("\nssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" rsa "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-b")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"your_email@example.com"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 输入 rsa 文件名, 默认为 id_rsa")]),s._v("\nEnter a "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" to save the key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/home/you/.ssh/id_rsa"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Press enter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id_rsa_new")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3. 输入密码短语（无密码短语为空）")]),s._v("\nEnter passphrase "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("empty "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" no passphrase"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Type a passphrase"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nEnter same passphrase again: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Type passphrase again"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4. 快速生成 ssh key")]),s._v("\nssh-keygen "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ~/.ssh/id_rsa  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-P")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-q")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可修改文件名，还可接续上面的配置")]),s._v("\n")])])]),a("p",[s._v("再需要将生成的密钥对的公钥上传到服务器，虽然可以手动上传（FTP、VIM），但使用 SSH 提供的工具更为轻松：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -i 指定公钥，可忽略 `.pub` 后缀")]),s._v("\nssh-copy-id "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" id_rsa_name.pub user@hostname\n")])])]),a("p",[s._v("再次登录服务器时就会发现不需要输入帐号密码了。")]),s._v(" "),a("h3",{attrs:{id:"客户端的快速访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端的快速访问"}},[s._v("#")]),s._v(" 客户端的快速访问")]),s._v(" "),a("p",[s._v("总是指定用户、服务器地址、密钥是一件麻烦的事情，可以写在配置文件中：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编辑 config 文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" ~/.ssh/config\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 config 文件末尾追加内容")]),s._v("\nHost aliyun "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个便于你区别这是哪台机器的名字")]),s._v("\n    HostName xxx.xxx.xxx.xxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 目的机器的 ip")]),s._v("\n    User root        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh 登陆时候的用户名")]),s._v("\n    Port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh 所使用的端口，默认是 22")]),s._v("\n    IdentityFile /home/yuan/.ssh/id_rsa_new "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对应服务器公钥的本地私钥文件路径")]),s._v("\n")])])]),a("p",[s._v("快速访问：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" aliyun\n")])])]),a("h2",{attrs:{id:"加固服务器的操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加固服务器的操作"}},[s._v("#")]),s._v(" 加固服务器的操作")]),s._v(" "),a("p",[s._v("这部分主要是对服务器端 "),a("code",[s._v("/etc/ssh/sshd_config")]),s._v(" 进行修改，修改完成后记得重启 "),a("code",[s._v("sshd")]),s._v(" 服务：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl restart sshd\n")])])]),a("h3",{attrs:{id:"基础操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础操作"}},[s._v("#")]),s._v(" 基础操作")]),s._v(" "),a("ol",[a("li",[s._v("修改默认的 sshd 端口，"),a("code",[s._v("Port")])]),s._v(" "),a("li",[s._v("禁用密码登录，"),a("code",[s._v("PasswordAuthentication")])]),s._v(" "),a("li",[s._v("禁止空密码，"),a("code",[s._v("PermitEmptyPasswords")])]),s._v(" "),a("li",[s._v("禁用 root，"),a("code",[s._v("PermitRootLogin")])]),s._v(" "),a("li",[s._v("登录用户白名单（多个用户之间添加空格），"),a("code",[s._v("AllowUsers")])]),s._v(" "),a("li",[s._v("登录用户组白名单："),a("code",[s._v("AllowGroups")])])]),s._v(" "),a("p",[s._v("修改完配置后进行验证：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("sshd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v("\n")])])]),a("h3",{attrs:{id:"ssh-隧道"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-隧道"}},[s._v("#")]),s._v(" SSH 隧道")]),s._v(" "),a("p",[s._v("可以使用 SSH 隧道（SSH Tunnel）的"),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Port_forwarding",target:"_blank",rel:"noopener noreferrer"}},[s._v("转发模式"),a("OutboundLink")],1),s._v("有三种：")]),s._v(" "),a("ul",[a("li",[s._v("本地端口转发（Local port forwarding）")]),s._v(" "),a("li",[s._v("远程端口转发（Remote port forwarding）")]),s._v(" "),a("li",[s._v("动态端口转发（Dynamic port forwarding）")])]),s._v(" "),a("p",[s._v("我们需要在本地访问部署在服务器上的服务，选择本地端口转发即可。例如在服务器的 30000 端口部署了 Web 服务。")]),s._v(" "),a("p",[s._v("可通过 "),a("code",[s._v("man ssh")]),s._v(" 查看语法：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("bind_address:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("port:host:hostport\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("bind_address:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("port:remote_socket\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" local_socket:host:hostport\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" local_socket:remote_socket\n")])])]),a("p",[s._v("选择第一种，"),a("code",[s._v("ip + port")]),s._v(" 的形式即可：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将服务器上 30000 端口转发到本地的 8080，打开浏览器即可验证")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -N 表示不登录服务器，仅转发端口")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" localhost:8080:localhost:30000 user@hostname "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-N")]),s._v("\n")])])]),a("p",[s._v("当 "),a("code",[s._v("bind_address")]),s._v(" 省略时，表示绑至所有网卡。在远程我们同样使用 "),a("code",[s._v("localhost")]),s._v(" 指定为服务器主机，你也可以使用对应的 IP 进行替换，如果在局域网内，也可指定为局域网内其他服务器的 IP 地址，例如在 "),a("code",[s._v("172.21.0.2")]),s._v(" 上：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将服务器上 80 端口转发到本地的 8080，打开浏览器即可验证")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" localhost:8080:172.21.0.2:80 user@hostname "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-N")]),s._v("\n")])])]),a("h3",{attrs:{id:"服务认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务认证"}},[s._v("#")]),s._v(" 服务认证")]),s._v(" "),a("p",[s._v("这一部分实际上是 Nginx 的内容，在构建了一些开源服务时，即使你在用户认证上做了充足的准备，但软件是人写的总是存在漏洞，可以添加 "),a("code",[s._v("Basic Auth")]),s._v(" 及 "),a("code",[s._v("IP 白名单")]),s._v(" 进行访问。")]),s._v(" "),a("h3",{attrs:{id:"fail2ban"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fail2ban"}},[s._v("#")]),s._v(" fail2ban")]),s._v(" "),a("p",[s._v("如果有黑客持续爆破你的服务器，那么可以使用 "),a("RouterLink",{attrs:{to:"/os/linux/fail2ban.html"}},[s._v("fail2ban")]),s._v(" 来限制他的 IP。")],1),s._v(" "),a("h2",{attrs:{id:"处理一些问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#处理一些问题"}},[s._v("#")]),s._v(" 处理一些问题")]),s._v(" "),a("h3",{attrs:{id:"修复-ssh-add-存在的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修复-ssh-add-存在的问题"}},[s._v("#")]),s._v(" 修复 ssh-add 存在的问题")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1. 生成新的 rsa 后需要链接到 ssh")]),s._v("\nssh-add ~/.ssh/id_rsa_new\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2. 然后此处会报错 Could not open a connection to your authentication agent.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3. 需要修复该问题")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("ssh-agent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4. 再一次将新生成的 rsa 链接到 ssh")]),s._v("\nssh-add ~/.ssh/id_rsa_new\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 5. 显示成功 ")]),s._v("\nIdentity added: /home/yuan/.ssh/id_rsa_new "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("your_email@example.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6. 测试是否成功")]),s._v("\nssh-add "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);
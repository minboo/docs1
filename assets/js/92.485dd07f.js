(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{375:function(a,t,s){"use strict";s.r(t);var n=s(8),e=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"如何搭建私有-gitlab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何搭建私有-gitlab"}},[a._v("#")]),a._v(" 如何搭建私有 GitLab")]),a._v(" "),t("h2",{attrs:{id:"安装-gitlab"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-gitlab"}},[a._v("#")]),a._v(" 安装 GitLab")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建数据目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /srv/gitlab/config /srv/gitlab/logs /srv/gitlab/data\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\ntree /srv\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装 gitlab")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--detach")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--hostname")]),a._v(" gitlab.example.com "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 注意修改 22 为 30022 后，利用 git 协议下载需指定其端口才可以下载，例如 git clone ssh://git@xxx.gitlab.com:port/.../xxx.git")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 可配置 ssh config 指定端口，减少操作")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 而 http 协议可正常下载（其实是因为 nginx 转了一层，否则也是得修改的）")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--publish")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("30443")]),a._v(":443 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--publish")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("30080")]),a._v(":80 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--publish")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("30022")]),a._v(":22 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),a._v(" /srv/gitlab/config:/etc/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),a._v(" /srv/gitlab/logs:/var/log/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--volume")]),a._v(" /srv/gitlab/data:/var/opt/gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gitlab "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  gitlab/gitlab-ce\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("netstat")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-tunlp")]),a._v("\n")])])]),t("p",[a._v("最后打开浏览器来验证。")]),a._v(" "),t("h2",{attrs:{id:"邮件服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#邮件服务"}},[a._v("#")]),a._v(" 邮件服务")]),a._v(" "),t("p",[a._v("多家对比后选择了"),t("a",{attrs:{href:"https://exmail.qq.com/",target:"_blank",rel:"noopener noreferrer"}},[a._v("腾讯企业邮箱"),t("OutboundLink")],1),a._v("，依次进入 "),t("code",[a._v("邮箱 => 邮箱设置 => 收发信设置 => 开启IMAP/SMTP服务")]),a._v("，再回到 "),t("code",[a._v("邮箱设置 => 邮箱绑定 => 安全登录")]),a._v(" 获取授权码即可（至于配置域名，邮件配置可另行谷歌）。")]),a._v(" "),t("h3",{attrs:{id:"_1-修改配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-修改配置"}},[a._v("#")]),a._v(" 1. 修改配置")]),a._v(" "),t("p",[a._v("找到 "),t("code",[a._v("Email Settings")]),a._v(" 在后面追加对应的 "),t("code",[a._v("SMTP")]),a._v(" 配置。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /srv/gitlab/config/gitlab.rb\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 开启 SMTP 功能")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_enable'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_address'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"smtp.exmail.qq.com"')]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_port'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("465")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_user_name'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"name@domain.com"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 邮件发送人")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'gitlab_email_from'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"name@domain.com"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 与 smtp_user_name 一致")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_password'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"password"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 获取的授权码")]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_domain'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"exmail.qq.com"')]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_authentication'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"login"')]),a._v("\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_enable_starttls_auto'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\ngitlab_rails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'smtp_tls'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true\n")])])]),t("h3",{attrs:{id:"_2-验证服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-验证服务"}},[a._v("#")]),a._v(" 2. 验证服务")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 以命令形式重新加载配置，也可进入容器后手动执行")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" gitlab gitlab-ctl reconfigure\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 进入 gitlab 容器")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" gitlab "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 开启 gitlab-rails")]),a._v("\ngitlab-rails console\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 测试邮件发送，可换为自己的邮箱")]),a._v("\nNotify.test_email"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'someone@example.com'")]),a._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'Message Subject'")]),a._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'Message Body'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(".deliver_now\n")])])]),t("p",[a._v("等待邮件发送到自己的邮箱后即可。")]),a._v(" "),t("h2",{attrs:{id:"hostname"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hostname"}},[a._v("#")]),a._v(" hostname")]),a._v(" "),t("p",[t("code",[a._v("hostname")]),a._v(" 会影响仓库下载、用户注册邀请等问题。")]),a._v(" "),t("p",[a._v("在安装 "),t("code",[a._v("gitlab")]),a._v(" 时为其设置 "),t("code",[a._v("hostname")]),a._v(" 为 "),t("code",[a._v("gitlab.example.com")]),a._v("，此处还需要修改为你对应的域名或 "),t("code",[a._v("ip")]),a._v(" 地址。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /srv/gitlab/config/gitlab.rb\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置 external_url")]),a._v("\nexternal_url "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'http://gitlab.example.com'")]),a._v("\n")])])]),t("h2",{attrs:{id:"备份与恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份与恢复"}},[a._v("#")]),a._v(" 备份与恢复")]),a._v(" "),t("blockquote",[t("p",[a._v("一个有意思的尝试是直接更新镜像也会自动迁移配置，商业数据请小心该尝试")])]),a._v(" "),t("p",[a._v("由于开始就将数据卷挂载到 "),t("code",[a._v("/srv/gitlab")]),a._v(" 下，所以备份的数据也会在该目录的 "),t("code",[a._v("/srv/gitlab/data/backups")]),a._v(" 中。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# GitLab 12.2 之后的版本备份指令")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("container name"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" gitlab-backup create\n")])])]),t("p",[a._v("更好的形式是定期备份：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("crontab")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 每天凌晨4点备份")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),a._v(" * * * "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" gitlab gitlab-backup create "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 每天凌晨4点备份删除 7 天前备份")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),a._v(" * * * "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /srv/gitlab/data/backups/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +7 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-name")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*gitlab_backup.tar"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-delete")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null\n")])])]),t("p",[a._v("根据备份恢复数据：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 停止服务")]),a._v("\ngitlab-ctl stop unicorn "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 应用服务器")]),a._v("\ngitlab-ctl stop sidekiq "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 后台异步任务队列")]),a._v("\ngitlab-ctl status "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 验证")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 指定数据")]),a._v("\ngitlab-rake gitlab:backup:restore "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("1607523472_2020_12_09_13.2.1\n")])])]),t("h2",{attrs:{id:"快速而简单的升级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#快速而简单的升级"}},[a._v("#")]),a._v(" 快速而简单的升级")]),a._v(" "),t("p",[a._v("使用 Docker Compose 进行维护，找到新的"),t("a",{attrs:{href:"https://hub.docker.com/r/gitlab/gitlab-ce/tags",target:"_blank",rel:"noopener noreferrer"}},[a._v("镜像"),t("OutboundLink")],1),a._v("替换上，注意大版本的升级变动。")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker-compose")]),a._v(" down\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker-compose")]),a._v(" up\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 等待完成")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker-compose")]),a._v(" logs "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v("\n")])])]),t("h2",{attrs:{id:"添加-runner"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加-runner"}},[a._v("#")]),a._v(" 添加 Runner")]),a._v(" "),t("p",[a._v("先注册 GitLab Runner：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 注册（删除 register 及以后可交互式注册）")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-it")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /srv/gitlab-runner/config:/etc/gitlab-runner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  gitlab/gitlab-runner:latest register "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --non-interactive "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--url")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://gitlab.com/"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --registration-token "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PROJECT_REGISTRATION_TOKEN"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--executor")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --docker-image "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker:19.03.12"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--description")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker-runner"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# --docker-privileged 判断是否需要")]),a._v("\n    --docker-privileged "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --tag-list "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"docker"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --run-untagged"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"true"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--locked")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"false"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    --access-level"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"not_protected"')]),a._v("\n")])])]),t("p",[a._v("再前往 "),t("code",[a._v("/srv/gitlab-runner/config/config.toml")]),a._v(" 修改 "),t("code",[a._v("volumes")]),a._v("：")]),a._v(" "),t("div",{staticClass:"language-toml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-toml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改前：")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[a._v("runners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ...")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[a._v("runners.docker")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key property"}},[a._v("volumes")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/cache"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 修改后：")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[a._v("runners")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# ...")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token table class-name"}},[a._v("runners.docker")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key property"}},[a._v("volumes")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/cache"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/var/run/docker.sock:/var/run/docker.sock"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])])]),t("p",[a._v("最后启动 Runner：")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),a._v(" always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /srv/gitlab-runner/config:/etc/gitlab-runner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/run/docker.sock:/var/run/docker.sock "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" gitlab-runner "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  gitlab/gitlab-runner:latest\n")])])]),t("h3",{attrs:{id:"privileged"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#privileged"}},[a._v("#")]),a._v(" privileged")]),a._v(" "),t("p",[a._v("当存在 "),t("code",[a._v("error during connect no such host")]),a._v(" 报错时修改 runner config 的 "),t("code",[a._v("privileged")]),a._v(" 属性为 "),t("code",[a._v("true")]),a._v("。")]),a._v(" "),t("h3",{attrs:{id:"自签证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自签证书"}},[a._v("#")]),a._v(" 自签证书")]),a._v(" "),t("p",[a._v("根据 "),t("a",{attrs:{href:"https://docs.gitlab.com/runner/configuration/tls-self-signed.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("tls-self-signed"),t("OutboundLink")],1),a._v(" 去信任 ca：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 宿主机")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" /etc/gitlab-runner/certs/ca.crt gitlab-runner-node:/usr/local/share/ca-certificates/ca.crt\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 容器内")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" ca-certificates\nupdate-ca-certificates "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--fresh")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" https://example.com "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 访问成功")]),a._v("\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);